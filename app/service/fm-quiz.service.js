"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var Observable_1 = require("rxjs/Observable");
var _ = require("lodash");
// Services
var fm_card_service_1 = require("./fm-card.service");
var fm_database_service_1 = require("./fm-database.service");
// Statics & Domains
var static_data_1 = require("../shared/static-data");
var FMQuizService = /** @class */ (function () {
    function FMQuizService(cardService, dbService) {
        var _this = this;
        this.cardService = cardService;
        this.dbService = dbService;
        this._myQuizzes = [];
        this.clearFilter();
        this.fetchQuizzes().subscribe(function (success) { return _this._isLoading = false; });
    }
    FMQuizService.prototype.fetchQuizzes = function () {
        var _this = this;
        this._isLoading = true;
        return Observable_1.Observable.create(function (observer) {
            _this.dbService.getAllQuizzesWithItems().then(function (rows) {
                _this._myQuizzes = [];
                var quiz = { id: -1, title: '', cardIds: [] };
                var first = true;
                var lastId = -1;
                rows.forEach(function (row) {
                    if (lastId !== row[static_data_1.QuizTable.ID] && !first) {
                        _this._myQuizzes.push(quiz);
                        quiz = { id: -1, title: '', cardIds: [] };
                    }
                    lastId = row[static_data_1.QuizTable.ID];
                    first = false;
                    quiz.id = row[static_data_1.QuizTable.ID];
                    quiz.title = row[static_data_1.QuizTable.TITLE];
                    if (row[static_data_1.QuizItemTable.ITEM_TYPE] === static_data_1.QuizItemType.CARD) {
                        quiz.cardIds.push(row[static_data_1.QuizItemTable.ITEM_ID]);
                    }
                });
                if (!first) {
                    _this._myQuizzes.push(quiz);
                }
                observer.next(true);
                observer.complete();
            });
        });
    };
    FMQuizService.prototype.parseFMQuizListItem = function (fmQuiz) {
        var q = {
            id: fmQuiz.id,
            title: fmQuiz.title,
            cardIds: []
        };
        fmQuiz.cards.forEach(function (card) { return q.cardIds.push(card.id); });
        return q;
    };
    FMQuizService.prototype.clearFilter = function () {
        this._filteredQuizzes = this._myQuizzes;
    };
    FMQuizService.prototype.getQuizzes = function () {
        return this._filteredQuizzes;
    };
    FMQuizService.prototype.getQuiz = function (id) {
        var _this = this;
        var quizListItem = _.find(this._myQuizzes, function (quiz) { return quiz.id === id; });
        var result = {
            id: quizListItem.id,
            title: quizListItem.title,
            cards: []
        };
        quizListItem.cardIds.forEach(function (id) {
            result.cards.push(_this.cardService.getCard(id));
        });
        return result;
    };
    FMQuizService.prototype.addQuiz = function (quiz) {
        var _this = this;
        return Observable_1.Observable.create(function (observer) {
            _this.dbService.insertNewQuiz(quiz).then(function (id) {
                quiz.id = id;
                _this._myQuizzes.push(_this.parseFMQuizListItem(quiz));
                observer.next(true);
                observer.complete();
            });
        });
    };
    FMQuizService.prototype.updateQuiz = function (quiz) {
        var _this = this;
        return Observable_1.Observable.create(function (observer) {
            _this.dbService.updateQuiz(quiz.id, quiz.title).then(function (countQuiz) {
                _this.dbService.deleteQuizItemByQuizId(quiz.id).then(function (deleteCount) {
                    _this.dbService.insertNewQuizItem(quiz).then(function (countQuizItem) {
                        _.remove(_this._myQuizzes, function (quizItem) { return quizItem.id === quiz.id; });
                        _this._myQuizzes.push(_this.parseFMQuizListItem(quiz));
                        observer.next(true);
                        observer.complete();
                    });
                });
            });
        });
    };
    FMQuizService.prototype.deleteQuiz = function (id) {
        var _this = this;
        return Observable_1.Observable.create(function (observer) {
            _this.dbService.deleteQuiz(id).then(function (quizCount) {
                _this.dbService.deleteQuizItemByQuizId(id).then(function (quizItemCount) {
                    _.remove(_this._myQuizzes, function (quiz) { return quiz.id === id; });
                    observer.next(true);
                    observer.complete();
                });
            });
        });
    };
    FMQuizService = __decorate([
        core_1.Injectable(),
        __metadata("design:paramtypes", [fm_card_service_1.FMCardService,
            fm_database_service_1.FMDatabaseService])
    ], FMQuizService);
    return FMQuizService;
}());
exports.FMQuizService = FMQuizService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm0tcXVpei5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZm0tcXVpei5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsc0NBQTJDO0FBQzNDLDhDQUE2QztBQUM3QywwQkFBNEI7QUFFNUIsV0FBVztBQUNYLHFEQUFrRDtBQUNsRCw2REFBMEQ7QUFFMUQsb0JBQW9CO0FBQ3BCLHFEQUErRTtBQU8vRTtJQU1JLHVCQUNZLFdBQTBCLEVBQzFCLFNBQTRCO1FBRnhDLGlCQU9DO1FBTlcsZ0JBQVcsR0FBWCxXQUFXLENBQWU7UUFDMUIsY0FBUyxHQUFULFNBQVMsQ0FBbUI7UUFFcEMsSUFBSSxDQUFDLFVBQVUsR0FBRyxFQUFFLENBQUM7UUFDckIsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ25CLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQyxTQUFTLENBQUMsVUFBQSxPQUFPLElBQUksT0FBQSxLQUFJLENBQUMsVUFBVSxHQUFHLEtBQUssRUFBdkIsQ0FBdUIsQ0FBQyxDQUFDO0lBQ3RFLENBQUM7SUFFTyxvQ0FBWSxHQUFwQjtRQUFBLGlCQThCQztRQTdCRyxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztRQUN2QixNQUFNLENBQUMsdUJBQVUsQ0FBQyxNQUFNLENBQUMsVUFBQSxRQUFRO1lBQzdCLEtBQUksQ0FBQyxTQUFTLENBQUMsc0JBQXNCLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBQSxJQUFJO2dCQUM3QyxLQUFJLENBQUMsVUFBVSxHQUFHLEVBQUUsQ0FBQztnQkFDckIsSUFBSSxJQUFJLEdBQW1CLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsT0FBTyxFQUFFLEVBQUUsRUFBRSxDQUFDO2dCQUM5RCxJQUFJLEtBQUssR0FBWSxJQUFJLENBQUM7Z0JBQzFCLElBQUksTUFBTSxHQUFXLENBQUMsQ0FBQyxDQUFDO2dCQUN4QixJQUFJLENBQUMsT0FB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QUFDLElBQUksQ0FBQyxLQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQzt3QkFDckQsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzt3QkFDcEIsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFDO29CQUN4QixDQUFDLENBQUMsQ0FBQztnQkFDUCxDQUFDLENBQUMsQ0FBQztZQUNQLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRU0sa0NBQVUsR0FBakIsVUFBa0IsRUFBVTtRQUE1QixpQkFVQztRQVRHLE1BQU0sQ0FBQyx1QkFBVSxDQUFDLE1BQU0sQ0FBQyxVQUFBLFFBQVE7WUFDN0IsS0FBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUEsU0FBUztnQkFDeEMsS0FBSSxDQUFDLFNBQVMsQ0FBQyxzQkFBc0IsQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQSxhQUFhO29CQUN4RCxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUksQ0FBQyxVQUFVLEVBQUUsVUFBQSxJQUFJLElBQUksT0FBQSxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsRUFBZCxDQUFjLENBQUMsQ0FBQztvQkFDbEQsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDcEIsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFDO2dCQUN4QixDQUFDLENBQUMsQ0FBQztZQUNQLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBbEhRLGFBQWE7UUFEekIsaUJBQVUsRUFBRTt5Q0FRZ0IsK0JBQWE7WUFDZix1Q0FBaUI7T0FSL0IsYUFBYSxDQW1IekI7SUFBRCxvQkFBQztDQUFBLEFBbkhELElBbUhDO0FBbkhZLHNDQUFhIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMvT2JzZXJ2YWJsZSc7XG5pbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaCc7XG5cbi8vIFNlcnZpY2VzXG5pbXBvcnQgeyBGTUNhcmRTZXJ2aWNlIH0gZnJvbSAnLi9mbS1jYXJkLnNlcnZpY2UnO1xuaW1wb3J0IHsgRk1EYXRhYmFzZVNlcnZpY2UgfSBmcm9tICcuL2ZtLWRhdGFiYXNlLnNlcnZpY2UnO1xuXG4vLyBTdGF0aWNzICYgRG9tYWluc1xuaW1wb3J0IHsgUXVpelRhYmxlLCBRdWl6SXRlbVRhYmxlLCBRdWl6SXRlbVR5cGUgfSBmcm9tICcuLi9zaGFyZWQvc3RhdGljLWRhdGEnO1xuaW1wb3J0IHsgRmlzaE1lbW9yeURvbWFpbiB9IGZyb20gJy4uL3R5cGluZy9kb21haW5zJztcbmltcG9ydCBGTVF1aXpMaXN0SXRlbSA9IEZpc2hNZW1vcnlEb21haW4uRk1RdWl6TGlzdEl0ZW07XG5pbXBvcnQgRk1RdWl6ID0gRmlzaE1lbW9yeURvbWFpbi5GTVF1aXo7XG5cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEZNUXVpelNlcnZpY2Uge1xuXG4gICAgcHJpdmF0ZSBfbXlRdWl6emVzOiBGTVF1aXpMaXN0SXRlbVtdO1xuICAgIHByaXZhdGUgX2ZpbHRlcmVkUXVpenplczogRk1RdWl6TGlzdEl0ZW1bXTtcbiAgICBwcml2YXRlIF9pc0xvYWRpbmc6IGJvb2xlYW47XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBjYXJkU2VydmljZTogRk1DYXJkU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBkYlNlcnZpY2U6IEZNRGF0YWJhc2VTZXJ2aWNlXG4gICAgKSB7XG4gICAgICAgIHRoaXMuX215UXVpenplcyA9IFtdO1xuICAgICAgICB0aGlzLmNsZWFyRmlsdGVyKCk7XG4gICAgICAgIHRoaXMuZmV0Y2hRdWl6emVzKCkuc3Vic2NyaWJlKHN1Y2Nlc3MgPT4gdGhpcy5faXNMb2FkaW5nID0gZmFsc2UpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZmV0Y2hRdWl6emVzKCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgICAgICB0aGlzLl9pc0xvYWRpbmcgPSB0cnVlO1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5jcmVhdGUob2JzZXJ2ZXIgPT4ge1xuICAgICAgICAgICAgdGhpcy5kYlNlcnZpY2UuZ2V0QWxsUXVpenplc1dpdGhJdGVtcygpLnRoZW4ocm93cyA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5fbXlRdWl6emVzID0gW107XG4gICAgICAgICAgICAgICAgbGV0IHF1aXo6IEZNUXVpekxpc3RJdGVtID0geyBpZDogLTEsIHRpdGxlOiAnJywgY2FyZElkczogW10gfTtcbiAgICAgICAgICAgICAgICBsZXQgZmlyc3Q6IGJvb2xlYW4gPSB0cnVlO1xuICAgICAgICAgICAgICAgIGxldCBsYXN0SWQ6IG51bWJlciA9IC0xO1xuICAgICAgICAgICAgICAgIHJvd3MuZm9yRWFjaChyb3cgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAobGFzdElkICE9PSByb3dbUXVpelRhYmxlLklEXSAmJiAhZmlyc3QpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX215UXVpenplcy5wdXNoKHF1aXopO1xuICAgICAgICAgICAgICAgICAgICAgICAgcXVpeiA9IHsgaWQ6IC0xLCB0aXRsZTogJycsIGNhcmRJZHM6IFtdIH07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgbGFzdElkID0gcm93W1F1aXpUYWJsZS5JRF07XG4gICAgICAgICAgICAgICAgICAgIGZpcnN0ID0gZmFsc2U7XG5cbiAgICAgICAgICAgICAgICAgICAgcXVpei5pZCA9IHJvd1tRdWl6VGFibGUuSURdO1xuICAgICAgICAgICAgICAgICAgICBxdWl6LnRpdGxlID0gcm93W1F1aXpUYWJsZS5USVRMRV07XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKHJvd1tRdWl6SXRlbVRhYmxlLklURU1fVFlQRV0gPT09IFF1aXpJdGVtVHlwZS5DQVJEKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBxdWl6LmNhcmRJZHMucHVzaChyb3dbUXVpekl0ZW1UYWJsZS5JVEVNX0lEXSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBpZiAoIWZpcnN0KSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX215UXVpenplcy5wdXNoKHF1aXopO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KHRydWUpO1xuICAgICAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwYXJzZUZNUXVpekxpc3RJdGVtKGZtUXVpejogRk1RdWl6KTogRk1RdWl6TGlzdEl0ZW0ge1xuICAgICAgICBsZXQgcTogRk1RdWl6TGlzdEl0ZW0gPSB7XG4gICAgICAgICAgICBpZDogZm1RdWl6LmlkLFxuICAgICAgICAgICAgdGl0bGU6IGZtUXVpei50aXRsZSxcbiAgICAgICAgICAgIGNhcmRJZHM6IFtdXG4gICAgICAgIH07XG4gICAgICAgIGZtUXVpei5jYXJkcy5mb3JFYWNoKGNhcmQgPT4gcS5jYXJkSWRzLnB1c2goY2FyZC5pZCkpO1xuICAgICAgICByZXR1cm4gcTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY2xlYXJGaWx0ZXIoKSB7XG4gICAgICAgIHRoaXMuX2ZpbHRlcmVkUXVpenplcyA9IHRoaXMuX215UXVpenplcztcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0UXVpenplcygpOiBGTVF1aXpMaXN0SXRlbVtdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2ZpbHRlcmVkUXVpenplcztcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0UXVpeihpZDogbnVtYmVyKTogRk1RdWl6IHtcbiAgICAgICAgbGV0IHF1aXpMaXN0SXRlbSA9IF8uZmluZCh0aGlzLl9teVF1aXp6ZXMsIHF1aXogPT4gcXVpei5pZCA9PT0gaWQpO1xuICAgICAgICBsZXQgcmVzdWx0OiBGTVF1aXogPSB7XG4gICAgICAgICAgICBpZDogcXVpekxpc3RJdGVtLmlkLFxuICAgICAgICAgICAgdGl0bGU6IHF1aXpMaXN0SXRlbS50aXRsZSxcbiAgICAgICAgICAgIGNhcmRzOiBbXVxuICAgICAgICB9O1xuICAgICAgICBxdWl6TGlzdEl0ZW0uY2FyZElkcy5mb3JFYWNoKGlkID0+IHtcbiAgICAgICAgICAgIHJlc3VsdC5jYXJkcy5wdXNoKHRoaXMuY2FyZFNlcnZpY2UuZ2V0Q2FyZChpZCkpO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICBwdWJsaWMgYWRkUXVpeihxdWl6OiBGTVF1aXopOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKG9ic2VydmVyID0+IHtcbiAgICAgICAgICAgIHRoaXMuZGJTZXJ2aWNlLmluc2VydE5ld1F1aXoocXVpeikudGhlbihpZCA9PiB7XG4gICAgICAgICAgICAgICAgcXVpei5pZCA9IGlkO1xuICAgICAgICAgICAgICAgIHRoaXMuX215UXVpenplcy5wdXNoKHRoaXMucGFyc2VGTVF1aXpMaXN0SXRlbShxdWl6KSk7XG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dCh0cnVlKTtcbiAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyB1cGRhdGVRdWl6KHF1aXo6IEZNUXVpeik6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5jcmVhdGUob2JzZXJ2ZXIgPT4ge1xuICAgICAgICAgICAgdGhpcy5kYlNlcnZpY2UudXBkYXRlUXVpeihxdWl6LmlkLCBxdWl6LnRpdGxlKS50aGVuKGNvdW50UXVpeiA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5kYlNlcnZpY2UuZGVsZXRlUXVpekl0ZW1CeVF1aXpJZChxdWl6LmlkKS50aGVuKGRlbGV0ZUNvdW50ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kYlNlcnZpY2UuaW5zZXJ0TmV3UXVpekl0ZW0ocXVpeikudGhlbihjb3VudFF1aXpJdGVtID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIF8ucmVtb3ZlKHRoaXMuX215UXVpenplcywgcXVpekl0ZW0gPT4gcXVpekl0ZW0uaWQgPT09IHF1aXouaWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fbXlRdWl6emVzLnB1c2godGhpcy5wYXJzZUZNUXVpekxpc3RJdGVtKHF1aXopKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLm5leHQodHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZGVsZXRlUXVpeihpZDogbnVtYmVyKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmNyZWF0ZShvYnNlcnZlciA9PiB7XG4gICAgICAgICAgICB0aGlzLmRiU2VydmljZS5kZWxldGVRdWl6KGlkKS50aGVuKHF1aXpDb3VudCA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5kYlNlcnZpY2UuZGVsZXRlUXVpekl0ZW1CeVF1aXpJZChpZCkudGhlbihxdWl6SXRlbUNvdW50ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgXy5yZW1vdmUodGhpcy5fbXlRdWl6emVzLCBxdWl6ID0+IHF1aXouaWQgPT09IGlkKTtcbiAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dCh0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG59Il19