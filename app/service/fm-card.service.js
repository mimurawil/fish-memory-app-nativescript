"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var _ = require("lodash");
var Observable_1 = require("rxjs/Observable");
// Services
var fm_database_service_1 = require("../service/fm-database.service");
// Statics & Domains
var static_data_1 = require("../shared/static-data");
var FMCardService = /** @class */ (function () {
    function FMCardService(dbService) {
        this.dbService = dbService;
        this._myCards = [];
        this._filteredCards = this._myCards;
        this.fetchCards().subscribe(function (success) { });
    }
    FMCardService.prototype.fetchCards = function () {
        var _this = this;
        return Observable_1.Observable.create(function (observer) {
            _this.dbService.getAllCards()
                .then(function (result) {
                _this._myCards = [];
                result.forEach(function (row) {
                    var card = {
                        id: row[static_data_1.CardTable.ID],
                        frontText: row[static_data_1.CardTable.FRONT_TEXT],
                        backText: row[static_data_1.CardTable.BACK_TEXT]
                    };
                    _this._myCards.push(card);
                });
                observer.next(true);
                observer.complete();
            });
        });
    };
    FMCardService.prototype.clearFilter = function () {
        this._filteredCards = this._myCards;
    };
    FMCardService.prototype.filter = function (options) {
        if (options === void 0) { options = {}; }
        if (options.without) {
            this._filteredCards = _.without.apply(_, [this._myCards].concat(options.without));
        }
    };
    FMCardService.prototype.getCards = function () {
        return this._filteredCards;
    };
    FMCardService.prototype.getCard = function (id) {
        return _.find(this._myCards, function (myCard) { return myCard.id === id; });
    };
    FMCardService.prototype.addCard = function (card) {
        var _this = this;
        return Observable_1.Observable.create(function (observer) {
            _this.dbService.insertNewCard(card)
                .then(function (id) {
                card.id = id;
                _this._myCards.push(card);
                observer.next(true);
                observer.complete();
            });
        });
    };
    FMCardService.prototype.updateCard = function (card) {
        var _this = this;
        return Observable_1.Observable.create(function (observer) {
            if (!card.id) {
                observer.next(false);
                observer.complete();
            }
            else {
                _this.dbService.updateCard(card)
                    .then(function (count) {
                    var theCard = _.find(_this._myCards, function (myCard) { return myCard.id === card.id; });
                    theCard.frontText = card.frontText;
                    theCard.backText = card.backText;
                    observer.next(true);
                    observer.complete();
                });
            }
        });
    };
    FMCardService.prototype.deleteCard = function (id) {
        var _this = this;
        return Observable_1.Observable.create(function (observer) {
            _this.dbService.deleteCard(id)
                .then(function (count) {
                _.remove(_this._myCards, function (myCard) { return myCard.id === id; });
                observer.next(true);
                observer.complete();
            });
        });
    };
    FMCardService = __decorate([
        core_1.Injectable(),
        __metadata("design:paramtypes", [fm_database_service_1.FMDatabaseService])
    ], FMCardService);
    return FMCardService;
}());
exports.FMCardService = FMCardService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm0tY2FyZC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZm0tY2FyZC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsc0NBQTJDO0FBQzNDLDBCQUE0QjtBQUM1Qiw4Q0FBNkM7QUFFN0MsV0FBVztBQUNYLHNFQUFtRTtBQUVuRSxvQkFBb0I7QUFDcEIscURBQWtEO0FBTWxEO0lBS0ksdUJBQ1ksU0FBNEI7UUFBNUIsY0FBUyxHQUFULFNBQVMsQ0FBbUI7UUFFcEMsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUM7UUFDbkIsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDO1FBQ3BDLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQyxTQUFTLENBQUMsVUFBQSxPQUFPLElBQU0sQ0FBQyxDQUFDLENBQUM7SUFDaEQsQ0FBQztJQUVPLGtDQUFVLEdBQWxCO1FBQUEsaUJBaUJDO1FBaEJHLE1BQU0sQ0FBQyx1QkFBVSxDQUFDLE1BQU0sQ0FBQyxVQUFBLFFBQVE7WUFDN0IsS0FBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLEVBQUU7aUJBQ3ZCLElBQUksQ0FBQyxVQUFBLE1BQU07Z0JBQ1IsS0FBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUM7Z0JBQ25CLE1BQU0sQ0FBQyxPQUFPLENBQUMsVUFBQSxHQUFHO29CQUNkLElBQUksSUFBSSxHQUFXO3dCQUNmLEVBQUUsRUFBRSxHQUFHLENBQUMsdUJBQVMsQ0FBQyxFQUFFLENBQUM7d0JBQ3JCLFNBQVMsRUFBRSxHQUFHLENBQUMsdUJBQVMsQ0FBQyxVQUFVLENBQUM7d0JBQ3BDLFFBQVEsRUFBRSxHQUFHLENBQUMsdUJBQVMsQ0FBQyxTQUFTLENBQUM7cUJBQ3JDLENBQUM7b0JBQ0YsS0FBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQzdCLENBQUMsQ0FBQyxDQUFDO2dCQUNILFFBQVEsQ0FBQyxJQUFJLENB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QUUsQ0FBQztpQkFDeEIsSUFBSSxDQUFDLFVBQUEsS0FBSztnQkFDUCxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUksQ0FBQyxRQUFRLEVBQUUsVUFBQSxNQUFNLElBQUksT0FBQSxNQUFNLENBQUMsRUFBRSxLQUFLLEVBQUUsRUFBaEIsQ0FBZ0IsQ0FBQyxDQUFDO2dCQUNwRCxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNwQixRQUFRLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDeEIsQ0FBQyxDQUFDLENBQUM7UUFDWCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUF4RlEsYUFBYTtRQUR6QixpQkFBVSxFQUFFO3lDQU9jLHVDQUFpQjtPQU4vQixhQUFhLENBeUZ6QjtJQUFELG9CQUFDO0NBQUEsQUF6RkQsSUF5RkM7QUF6Rlksc0NBQWEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcy9PYnNlcnZhYmxlJztcblxuLy8gU2VydmljZXNcbmltcG9ydCB7IEZNRGF0YWJhc2VTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZS9mbS1kYXRhYmFzZS5zZXJ2aWNlJztcblxuLy8gU3RhdGljcyAmIERvbWFpbnNcbmltcG9ydCB7IENhcmRUYWJsZSB9IGZyb20gJy4uL3NoYXJlZC9zdGF0aWMtZGF0YSc7XG5pbXBvcnQgeyBGaXNoTWVtb3J5RG9tYWluIH0gZnJvbSAnLi4vdHlwaW5nL2RvbWFpbnMnO1xuaW1wb3J0IEZNQ2FyZCA9IEZpc2hNZW1vcnlEb21haW4uRk1DYXJkO1xuaW1wb3J0IEZNRmlsdGVyT3B0aW9ucyA9IEZpc2hNZW1vcnlEb21haW4uRk1GaWx0ZXJPcHRpb25zO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRk1DYXJkU2VydmljZSB7XG5cbiAgICBwcml2YXRlIF9teUNhcmRzOiBGTUNhcmRbXTtcbiAgICBwcml2YXRlIF9maWx0ZXJlZENhcmRzOiBGTUNhcmRbXTtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIGRiU2VydmljZTogRk1EYXRhYmFzZVNlcnZpY2VcbiAgICApIHtcbiAgICAgICAgdGhpcy5fbXlDYXJkcyA9IFtdO1xuICAgICAgICB0aGlzLl9maWx0ZXJlZENhcmRzID0gdGhpcy5fbXlDYXJkcztcbiAgICAgICAgdGhpcy5mZXRjaENhcmRzKCkuc3Vic2NyaWJlKHN1Y2Nlc3MgPT4geyB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGZldGNoQ2FyZHMoKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmNyZWF0ZShvYnNlcnZlciA9PiB7XG4gICAgICAgICAgICB0aGlzLmRiU2VydmljZS5nZXRBbGxDYXJkcygpXG4gICAgICAgICAgICAgICAgLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbXlDYXJkcyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQuZm9yRWFjaChyb3cgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGNhcmQ6IEZNQ2FyZCA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogcm93W0NhcmRUYWJsZS5JRF0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbnRUZXh0OiByb3dbQ2FyZFRhYmxlLkZST05UX1RFWFRdLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJhY2tUZXh0OiByb3dbQ2FyZFRhYmxlLkJBQ0tfVEVYVF1cbiAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9teUNhcmRzLnB1c2goY2FyZCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KHRydWUpO1xuICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY2xlYXJGaWx0ZXIoKSB7XG4gICAgICAgIHRoaXMuX2ZpbHRlcmVkQ2FyZHMgPSB0aGlzLl9teUNhcmRzO1xuICAgIH1cblxuICAgIHB1YmxpYyBmaWx0ZXIob3B0aW9uczogRk1GaWx0ZXJPcHRpb25zID0ge30pIHtcbiAgICAgICAgaWYgKG9wdGlvbnMud2l0aG91dCkge1xuICAgICAgICAgICAgdGhpcy5fZmlsdGVyZWRDYXJkcyA9IF8ud2l0aG91dCh0aGlzLl9teUNhcmRzLCAuLi5vcHRpb25zLndpdGhvdXQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGdldENhcmRzKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fZmlsdGVyZWRDYXJkcztcbiAgICB9XG4gICAgcHVibGljIGdldENhcmQoaWQ6IG51bWJlcikge1xuICAgICAgICByZXR1cm4gXy5maW5kKHRoaXMuX215Q2FyZHMsIG15Q2FyZCA9PiBteUNhcmQuaWQgPT09IGlkKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYWRkQ2FyZChjYXJkOiBGTUNhcmQpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKG9ic2VydmVyID0+IHtcbiAgICAgICAgICAgIHRoaXMuZGJTZXJ2aWNlLmluc2VydE5ld0NhcmQoY2FyZClcbiAgICAgICAgICAgICAgICAudGhlbihpZCA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNhcmQuaWQgPSBpZDtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbXlDYXJkcy5wdXNoKGNhcmQpO1xuICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KHRydWUpO1xuICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgdXBkYXRlQ2FyZChjYXJkOiBGTUNhcmQpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKG9ic2VydmVyID0+IHtcbiAgICAgICAgICAgIGlmICghY2FyZC5pZCkge1xuICAgICAgICAgICAgICAgIG9ic2VydmVyLm5leHQoZmFsc2UpO1xuICAgICAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuZGJTZXJ2aWNlLnVwZGF0ZUNhcmQoY2FyZClcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oY291bnQgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHRoZUNhcmQ6IEZNQ2FyZCA9IF8uZmluZCh0aGlzLl9teUNhcmRzLCBteUNhcmQgPT4gbXlDYXJkLmlkID09PSBjYXJkLmlkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoZUNhcmQuZnJvbnRUZXh0ID0gY2FyZC5mcm9udFRleHQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGVDYXJkLmJhY2tUZXh0ID0gY2FyZC5iYWNrVGV4dDtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLm5leHQodHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGRlbGV0ZUNhcmQoaWQ6IG51bWJlcik6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5jcmVhdGUob2JzZXJ2ZXIgPT4ge1xuICAgICAgICAgICAgdGhpcy5kYlNlcnZpY2UuZGVsZXRlQ2FyZChpZClcbiAgICAgICAgICAgICAgICAudGhlbihjb3VudCA9PiB7XG4gICAgICAgICAgICAgICAgICAgIF8ucmVtb3ZlKHRoaXMuX215Q2FyZHMsIG15Q2FyZCA9PiBteUNhcmQuaWQgPT09IGlkKTtcbiAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dCh0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxufSJdfQ==